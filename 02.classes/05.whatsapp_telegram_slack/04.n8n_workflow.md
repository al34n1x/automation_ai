# ü§ñ README ‚Äî Construcci√≥n de un flujo completo en **n8n** con Evolution API + AI Agent  

Este documento describe c√≥mo armar un workflow en **n8n** que recibe mensajes de WhatsApp a trav√©s de **Evolution API**, procesa el mensaje con un **Agente de IA** y responde autom√°ticamente al usuario en WhatsApp.  

---

## üìå Prerrequisitos
- Tener **Evolution API** desplegado y conectado a WhatsApp.  
- Un **workflow en n8n** con un nodo `Webhook` ya configurado y vinculado a Evolution API (ver README previo de integraci√≥n).  
- Acceso a un **proveedor de modelo de IA** (ej. OpenAI, Ollama, HuggingFace).  

---

## üõ†Ô∏è Pasos detallados

### 1) Conectar Webhook con un nodo `Set`
- En el canvas de n8n, conecta la salida de tu nodo `Webhook` hacia un nodo **`Set`**.  
- Este nodo nos permitir√° **mapear y normalizar** los datos que env√≠a Evolution API.  

---

### 2) Configurar el nodo `Set` en modo manual
- Abre el nodo `Set`.  
- Cambia el **modo de operaci√≥n** a **`Manual Mapping`**.  
- En la secci√≥n **Fields to Set**, agrega los siguientes atributos:  

---

### 3) Variables b√°sicas a mapear
Estas son claves comunes en el payload de Evolution API.  
> ‚ö†Ô∏è **Nota:** El payload puede variar seg√∫n el evento. Ajust√° las rutas si tu API env√≠a un JSON distinto.

- **chat_id**  
  - Tipo: `String`  
  - Value:  
    ```n8n
    {{ $json.body.data.key.remoteJid }}
    ```

- **apikey**  
  - Tipo: `String`  
  - Value:  
    ```n8n
    {{ $json.body.server_url }}
    ```

- **server_url**  
  - Tipo: `String`  
  - Value:  
    ```n8n
    {{ $json.body.server_url }}
    ```

- **message**  
  - Tipo: `String`  
  - Value:  
    ```n8n
    {{ $json.body.data.message.conversation }}
    ```

---

### 4) Agregar un nodo `AI Agent`
- Conecta el nodo `Set` hacia un **`AI Agent`**.  
- Este nodo se encargar√° de procesar el mensaje entrante con ayuda de un LLM.  

---

### 5) Definir prompt de usuario
En el campo **User Prompt** agrega:  

```text
El usuario env√≠a el siguiente mensaje:
user_name: {{ $json.chat_id }}
message: {{ $json.message }}
```

---

### 6) Definir prompt de sistema
En el campo **System Prompt** agrega:  

```text
Eres un bot, un asistente que responde a las consultas del usuario. Responde con la informaci√≥n que el usuario envi√≥.
```

---

### 7) Conectar el modelo de IA
- Selecciona el **proveedor de modelo** que prefieras: OpenAI, Ollama, HuggingFace, etc.  
- Configura el modelo seg√∫n tus credenciales y caso de uso.  

---

### 8) Agregar un nodo `Simple Memory`
- Conecta el **AI Agent** hacia un nodo **Simple Memory**.  
- Abre el nodo y configura:  
  - **Session ID**: `Define Below`  
  - **Key**:  
    ```n8n
    {{ $json.chat_id }}
    ```  
  - **Context Window Length**: entre `5` y `10` (define cu√°ntos mensajes previos recordar).  

---

### 9) Agregar un nodo `HTTP Request` (para responder v√≠a Evolution API)
- Conecta la salida del **AI Agent** hacia un nodo **HTTP Request**.  
- Este nodo ser√° el que env√≠e la respuesta de vuelta a WhatsApp.  

---

### 10) Configuraci√≥n del nodo `HTTP Request`
- **Method**: `POST`  
- **URL**:  

```n8n
{{ $('Edit Fields').item.json.server_url }}/message/sendText/{{ $('Edit Fields').item.json.instance_name }}
```

üìå Ver documentaci√≥n oficial: [Evolution API ‚Äî send-text](https://www.postman.com/agenciadgcode/evolution-api/request/ubhuf1u/send-text).  

- **Authentication**: `None`  
  > ‚ö†Ô∏è Solo en desarrollo. En producci√≥n deber√≠as usar `API Key` u otro esquema seguro.  

---

### 11) Configuraci√≥n de Headers
- Activa **Send Headers**.  
- Agrega el header:  
  - **Name**: `apikey`  
  - **Value**:  
    ```n8n
    {{ $('Edit Fields').item.json.apikey }}
    ```

---

### 12) Configuraci√≥n del Body
- Activa **Send Body**.  
- **Body Content Type**: `JSON`  
- **Specify Body**: `Using JSON`  

- Agrega el siguiente payload:  

```json
{
  "number": "{{ $('Edit Fields').item.json.chat_id }}",
  "text": "{{ $json.output }}",
  "delay": 2000
}
```

---

### 13) Activar el workflow
- Vuelve al canvas principal.  
- En la parte superior derecha, cambia el estado del workflow a **Active**.  

---

### 14) Probar el flujo
- Env√≠a un mensaje de WhatsApp a tu n√∫mero conectado a Evolution API.  
- Verifica que:  
  1. El mensaje llega a **n8n** a trav√©s del webhook.  
  2. El **AI Agent** procesa el texto y genera una respuesta.  
  3. El nodo **HTTP Request** env√≠a esa respuesta a WhatsApp.  

---

## ‚úÖ Resultado esperado
- Un flujo de extremo a extremo:  
  1. **Usuario escribe por WhatsApp**.  
  2. **Evolution API ‚Üí n8n (Webhook)** recibe el mensaje.  
  3. **Set Node** normaliza los datos.  
  4. **AI Agent** procesa el mensaje con memoria de contexto.  
  5. **HTTP Request** responde al usuario por WhatsApp.  

---

## üöÄ Pr√≥ximos pasos
- Mejorar el prompt para respuestas m√°s contextuales.  
- A√±adir integraci√≥n con un **CRM** (ej. Salesforce, HubSpot, Google Sheets).  
- Conectar a un **RAG pipeline** para responder con datos de tu empresa.  
- Configurar **seguridad** en los endpoints (`API Key`, `Basic Auth`).  

---

[‚¨Ö Back to Course Overview](../../README.md)
