# IntegraciÃ³n de Slack con n8n (con AI Agent)

Este documento explica cÃ³mo integrar **Slack** con **n8n**, crear un bot que responde menciones en canales y conectarlo con un **AI Agent**. Incluye introducciÃ³n, beneficios, pasos detallados y guÃ­a de resoluciÃ³n de problemas.

---

## ðŸ“Œ IntroducciÃ³n

**Slack** es una plataforma de mensajerÃ­a orientada a equipos que permite organizar conversaciones en canales, compartir archivos y conectar aplicaciones.  
Al integrarlo con **n8n**, podÃ©s:

- Automatizar respuestas en tiempo real.
- Usar IA para responder menciones y mensajes.
- Orquestar flujos con GSheets, Gmail, CRMs, APIs, etc.
- Registrar interacciones y generar mÃ©tricas.

---

## âœ… Requisitos

- Un dominio pÃºblico para tu instancia de **n8n** con HTTPS.
- Permisos de administrador en tu workspace de Slack.
- n8n corriendo (cloud u on-prem).
- Acceso a un modelo de IA (ej.: OpenAI) para el nodo **AI Agent**.

---

## ðŸš€ Pasos de ConfiguraciÃ³n

### A. Crear el Workspace y la App en Slack

1. Ir a [https://slack.com/](https://slack.com/) y crear un **nuevo workspace**.  
2. En el home del workspace, ir a **Add apps** â†’ **Browse Slack Marketplace** â†’ **Build**.  
3. Click en **Create New App** â†’ **From Scratch**.  
   - Dar un **nombre** a la app (ej.: `senpai-n8n-bot`).  
   - Seleccionar el **workspace** creado.  
4. En el panel izquierdo ir a **OAuth & Permissions**.  
   - En **Bot Token Scopes**, agregar:
     - `app_mentions:read`
     - `channels:join`
     - `channels:read`
     - `chat:write`
     - `chat:write.public` 
     - `channels:history`
     - `assistant:write`
     - `groups:history`
     - `im:history`
     - `im:read`
     - `im:write`
     - `incoming-webhook`
   - En **Redirect URLs**, agregar:
     ```
     https://<TU-DOMINIO>/rest/oauth2-credential/callback
     ```
     â†’ **Add** â†’ **Save URLs**.  
5. Subir y hacer click en **Install to <workspace>** â†’ **Allow**.  
6. Guardar:
   - **Bot User OAuth Token** (`xoxb-â€¦`).  
   - **Client ID** y **Client Secret** en **Basic Information**.  

---

### B. Configurar Event Subscriptions

1. En la configuraciÃ³n de la app, ir a **Event Subscriptions**.  
2. Activar **Enable Events**.  
3. En **Request URL**, pegar la URL que te da el **Slack Trigger** en n8n (se obtiene en el paso C).  
4. En **Subscribe to bot events**, agregar:  
   - `app_mention`  
   - *(opcional)* `message.channels`  

> NOTA: Es posible que necesites activar el workflow para poder verificar el URL

---

### C. Crear el Workflow en n8n

1. Crear un nuevo workflow.  
2. **Slack Trigger**:  
   - Crear nueva credencial â†’ pegar el **Bot User OAuth Token**.  
   - Opcional: agregar el **Signing Secret** desde Slack.  
   - Copiar la **Request URL** y pegarla en **Event Subscriptions â†’ Request URL** en Slack.  
3. **AI Agent**:  
   - Agregar un nodo **AI Agent**.  
   - En **System Message**, poner como expresiÃ³n:
     ```text
     You are a helpful assistant. You received a message from the user {{ $json.text }} and you must respond being kind and useful.
     ```
   - Conectar un modelo (ej.: OpenAI).  
4. **Simple Memory**:  
   - Agregar un nodo de memoria con ventana 5â€“10 y conectarlo al agente.  
5. **Slack â†’ Send Message**:  
   - Crear credencial **OAuth2** con **Client ID** y **Client Secret** â†’ **Save** â†’ **Connect**.  
   - Configurar:  
     - Resource: `Message`  
     - Operation: `Send`  
     - Send Message To: `Channel`  
     - Channel: `By Id` â†’  
       ```text
       {{ $json.body?.event?.channel || $json.event?.channel || $json.channel }}
       ```  
     - Message Type: `Simple Text Message`  
     - Message Text: `{{ $json.output }}`  
     - Desactivar **Include Link to Workflow**.  
6. Conectar el flujo:  
   **Slack Trigger â†’ AI Agent â†’ Memory â†’ Slack Send Message**.  
7. Activar el workflow.  

---

### D. Probar la integraciÃ³n

1. En Slack, invitar al bot a un canal (`/invite @TuBot`).  
2. Escribir `@TuBot hola`.  
3. Confirmar que n8n recibe el evento y el bot responde.  

---

## ðŸ›  SoluciÃ³n de Problemas

- **Request URL no verifica:**  
  - Confirmar que n8n estÃ© expuesto por **HTTPS**.  
  - Workflow debe estar **activo**.  

- **Bot no responde:**  
  - Revisar la ruta del mensaje en la ejecuciÃ³n del **Slack Trigger**.  
  - Ajustar `{{ $json.body?.event?.text }}` segÃºn corresponda.  

- **Error `not_in_channel`:**  
  - Agregar scope `channels:join` y **invitar** al bot al canal.  

- **Error de Redirect URL:**  
  - Revisar que la URL en **Redirect URLs** coincida exactamente con la de n8n.  

---

## ðŸ”’ Seguridad y Buenas PrÃ¡cticas

- Otorgar **solo los scopes necesarios**.  
- Rotar y revocar tokens expuestos.  
- Usar **Signing Secret** para validar requests.  
- Manejar logs sin exponer datos sensibles.  
- Usar variables de entorno en n8n para credenciales.  

---

## ðŸ“š Extensiones

- Crear **slash commands** (`/soporte`) que disparen flujos.  
- Usar **Block Kit** para mensajes ricos (botones, menÃºs).  
- Responder en **threads** usando `thread_ts`.  
- Integrar con **RAG** para enriquecer respuestas.  

---

## ðŸŽ¯ Resumen rÃ¡pido

1. Crear workspace y app en Slack.  
2. Configurar OAuth con scopes (`app_mentions:read`, `chat:write`, etc.).  
3. Guardar Bot Token + Client ID/Secret.  
4. En n8n, crear workflow con **Slack Trigger â†’ AI Agent â†’ Slack Send Message**.  
5. Probar mencionando al bot en un canal.  

---

## âœ¨ Resultado esperado

Cuando un usuario mencione al bot en un canal (`@TuBot`), n8n procesarÃ¡ el mensaje con IA y responderÃ¡ automÃ¡ticamente en el mismo canal.
